<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
  <title>MAI Admin - Database</title>
  <style>
    :root { 
      --bg:#0b1220; --panel:#0f172a; --panel2:#111827; --panel3:#1e293b;
      --border:#334155; --border-light:#475569; 
      --muted:#94a3b8; --text:#e5e7eb; --text-bright:#f1f5f9;
      --accent:#06b6d4; --accent-hover:#0891b2; 
      --success:#10b981; --danger:#ef4444;
    }
    * { box-sizing: border-box; }
    html, body { height:100%; margin:0; padding:0; }
    body { 
      background:var(--bg); color:var(--text); 
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      line-height:1.5;
    }
    .container { max-width:1400px; margin:0 auto; padding:20px; }
    h1 { color:var(--text-bright); margin:0 0 24px 0; font-size:28px; font-weight:700; }
    h2 { color:var(--text-bright); margin:0 0 16px 0; font-size:20px; font-weight:600; }
    h3 { color:var(--text-bright); margin:0 0 12px 0; font-size:16px; font-weight:600; }
    
    .card { 
      background:var(--panel); border:1px solid var(--border); 
      border-radius:12px; padding:20px; margin-bottom:24px;
      box-shadow:0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
    .card-header { 
      display:flex; justify-content:space-between; align-items:center; 
      margin-bottom:20px; padding-bottom:16px; border-bottom:1px solid var(--border);
    }
    
    .grid { display:grid; grid-template-columns:380px 1fr; gap:24px; }
    .sidebar { background:var(--panel2); border-radius:10px; padding:16px; border:1px solid var(--border); }
    .main-panel { background:var(--panel2); border-radius:10px; padding:20px; border:1px solid var(--border); }
    
    button, .btn {
      background:var(--panel3); color:var(--text); 
      border:1px solid var(--border-light); border-radius:8px; 
      padding:8px 16px; font-size:14px; font-weight:500;
      cursor:pointer; transition:all 0.2s;
      display:inline-flex; align-items:center; gap:6px;
    }
    button:hover { background:var(--border); border-color:var(--accent); }
    button.primary { background:var(--accent); border-color:var(--accent); color:white; }
    button.primary:hover { background:var(--accent-hover); }
    button.success { background:var(--success); border-color:var(--success); color:white; }
    button.success:hover { opacity:0.9; }
    button.danger { background:var(--danger); border-color:var(--danger); color:white; }
    button.danger:hover { opacity:0.9; }
    
    input[type=text], input[type=search], textarea, select {
      width:100%; background:var(--panel3); color:var(--text); 
      border:1px solid var(--border); border-radius:8px; 
      padding:10px 12px; font-size:14px; font-family:inherit;
    }
    input:focus, textarea:focus { outline:none; border-color:var(--accent); }
    textarea { 
      min-height:120px; line-height:1.6; resize:vertical;
      font-family:ui-monospace,SFMono-Regular,monospace;
    }
    label { display:block; color:var(--muted); font-size:13px; font-weight:500; margin-bottom:6px; }
    .form-group { margin-bottom:16px; }
    
    .key-list { 
      max-height:calc(100vh - 320px); overflow-y:auto;
      border:1px solid var(--border); border-radius:8px; background:var(--panel);
    }
    .key-item {
      padding:10px 12px; cursor:pointer; border-bottom:1px solid var(--border);
      transition:background 0.15s; font-family:monospace; font-size:13px;
    }
    .key-item:hover { background:var(--panel3); }
    .key-item.active { background:var(--accent); color:white; font-weight:500; }
    
    .toolbar { 
      display:flex; gap:8px; align-items:center; flex-wrap:wrap; 
      padding:12px; background:var(--panel); border-radius:8px;
      border:1px solid var(--border); margin-bottom:16px;
    }
    
    .metadata { 
      display:flex; gap:24px; padding:12px; background:var(--panel); 
      border-radius:8px; border:1px solid var(--border); margin-bottom:16px; font-size:13px;
    }
    .metadata-item { display:flex; flex-direction:column; gap:4px; }
    .metadata-label { color:var(--muted); font-weight:500; }
    .metadata-value { color:var(--text-bright); font-family:monospace; }
    
    #toast { 
      position:fixed; top:20px; right:20px; background:var(--panel2); 
      color:var(--text-bright); border:1px solid var(--border); 
      border-left:4px solid var(--accent); padding:14px 18px; border-radius:10px;
      display:none; min-width:300px; z-index:9999;
    }
    
    .editor-grid { display:grid; grid-template-columns:1fr 1fr; gap:16px; }
    .editor-panel { 
      background:var(--panel); padding:16px; border-radius:10px; border:1px solid var(--border);
    }
    
    .badge { 
      display:inline-block; padding:4px 10px; border-radius:999px; 
      font-size:11px; font-weight:600; background:var(--panel3); border:1px solid var(--border);
    }
    
    @media (max-width:1024px) {
      .grid { grid-template-columns:1fr; }
      .editor-grid { grid-template-columns:1fr; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ðŸŽ¨ MAI Database Admin</h1>
    
    <div class="card">
      <div class="card-header">
        <h2>Text Snippets Manager</h2>
        <div style="display:flex; gap:8px;">
          <button class="success" onclick="showCreateModal()">+ Create New</button>
          <button onclick="window.location.reload()">ðŸ”„ Refresh</button>
        </div>
      </div>
      
      <div class="grid">
        <div class="sidebar">
          <div class="form-group">
            <label for="search">Search Keys</label>
            <input type="search" id="search" placeholder="e.g., page.home..." oninput="filterKeys()">
          </div>
          
          <div class="toolbar">
            <button class="primary" onclick="loadKeys()">Load Keys</button>
            <span class="badge" id="key-count">0 keys</span>
          </div>
          
          <div class="key-list" id="key-list">
            <div style="padding:32px 16px; text-align:center; color:var(--muted);">Click "Load Keys"</div>
          </div>
        </div>
        
        <div class="main-panel" id="editor-panel">
          <div style="text-align:center; padding:60px 20px; color:var(--muted);">
            <h3>No key selected</h3>
            <p>Select a key from the sidebar or create a new one</p>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div id="toast"></div>
  
  <div id="create-modal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.7); z-index:10000; align-items:center; justify-content:center;">
    <div class="card" style="width:500px; max-width:90vw;">
      <h2>Create New Text Snippet</h2>
      <div class="form-group">
        <label for="new-key">Key (e.g., page.home.hero.title)</label>
        <input type="text" id="new-key" placeholder="page.section.element">
      </div>
      <div class="editor-grid">
        <div class="form-group">
          <label>English Text</label>
          <textarea id="new-en" rows="4"></textarea>
        </div>
        <div class="form-group">
          <label>Swedish Text</label>
          <textarea id="new-sv" rows="4"></textarea>
        </div>
      </div>
      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:16px;">
        <button onclick="hideCreateModal()">Cancel</button>
        <button class="primary" onclick="createKey()">Create</button>
      </div>
    </div>
  </div>
  
  <script>
    let allKeys = [];
    let filteredKeys = [];
    let currentKey = null;
    
    async function api(path, opts) {
      const res = await fetch(path, opts);
      const data = res.headers.get('content-type')?.includes('json') ? await res.json() : await res.text();
      if (!res.ok) throw new Error(typeof data === 'string' ? data : (data.error || 'Request failed'));
      return data;
    }
    
    function toast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.style.display = 'block';
      setTimeout(() => t.style.display = 'none', 4000);
    }
    
    async function loadKeys() {
      try {
        const data = await api('/api/db/text-snippets?limit=200');
        allKeys = data.items || [];
        filteredKeys = [...allKeys];
        renderKeyList();
        document.getElementById('key-count').textContent = `${allKeys.length} keys`;
        toast(`Loaded ${allKeys.length} keys`);
      } catch (err) {
        toast('Failed: ' + err.message);
      }
    }
    
    function filterKeys() {
      const query = document.getElementById('search').value.toLowerCase();
      filteredKeys = query ? allKeys.filter(i => i.key.toLowerCase().includes(query)) : [...allKeys];
      renderKeyList();
    }
    
    function renderKeyList() {
      const container = document.getElementById('key-list');
      if (!filteredKeys.length) {
        container.innerHTML = '<div style="padding:32px; text-align:center; color:var(--muted);">No keys found</div>';
        return;
      }
      container.innerHTML = filteredKeys.map(i => 
        `<div class="key-item ${currentKey?.key === i.key ? 'active' : ''}" onclick="selectKey('${esc(i.key)}')">${esc(i.key)}</div>`
      ).join('');
    }
    
    async function selectKey(key) {
      try {
        currentKey = await api(`/api/db/text-snippets/${encodeURIComponent(key)}`);
        renderEditor();
        renderKeyList();
      } catch (err) {
        toast('Failed: ' + err.message);
      }
    }
    
    function renderEditor() {
      if (!currentKey) return;
      const en = esc(currentKey.values?.en || '');
      const sv = esc(currentKey.values?.sv || '');
      const updated = currentKey.updated_at ? new Date(currentKey.updated_at).toLocaleString() : 'Never';
      
      document.getElementById('editor-panel').innerHTML = `
        <div class="metadata">
          <div class="metadata-item">
            <span class="metadata-label">Key</span>
            <span class="metadata-value">${esc(currentKey.key)}</span>
          </div>
          <div class="metadata-item">
            <span class="metadata-label">Last Updated</span>
            <span class="metadata-value">${updated}</span>
          </div>
        </div>
        <div class="editor-grid">
          <div class="editor-panel">
            <h3>ðŸ‡¬ðŸ‡§ English</h3>
            <textarea id="edit-en" rows="12">${en}</textarea>
          </div>
          <div class="editor-panel">
            <h3>ðŸ‡¸ðŸ‡ª Svenska</h3>
            <textarea id="edit-sv" rows="12">${sv}</textarea>
          </div>
        </div>
        <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:16px;">
          <button class="success" onclick="saveKey()">ðŸ’¾ Save Changes</button>
        </div>
      `;
    }
    
    async function saveKey() {
      if (!currentKey) return;
      const values = {
        en: document.getElementById('edit-en').value,
        sv: document.getElementById('edit-sv').value
      };
      try {
        await api(`/api/db/text-snippets/${encodeURIComponent(currentKey.key)}`, {
          method: 'PUT',
          headers: { 'content-type': 'application/json' },
          body: JSON.stringify({ values })
        });
        toast('Saved successfully!');
        await selectKey(currentKey.key);
      } catch (err) {
        toast('Save failed: ' + err.message);
      }
    }
    
    function showCreateModal() {
      document.getElementById('create-modal').style.display = 'flex';
    }
    
    function hideCreateModal() {
      document.getElementById('create-modal').style.display = 'none';
      document.getElementById('new-key').value = '';
      document.getElementById('new-en').value = '';
      document.getElementById('new-sv').value = '';
    }
    
    async function createKey() {
      const key = document.getElementById('new-key').value.trim();
      const en = document.getElementById('new-en').value;
      const sv = document.getElementById('new-sv').value;
      
      if (!key || !/^[a-zA-Z0-9_.:-]+$/.test(key)) {
        toast('Invalid key format');
        return;
      }
      if (!en && !sv) {
        toast('Provide at least one language');
        return;
      }
      
      try {
        const values = {};
        if (en) values.en = en;
        if (sv) values.sv = sv;
        await api(`/api/db/text-snippets/${encodeURIComponent(key)}`, {
          method: 'PUT',
          headers: { 'content-type': 'application/json' },
          body: JSON.stringify({ values })
        });
        toast('Created!');
        hideCreateModal();
        await loadKeys();
        await selectKey(key);
      } catch (err) {
        toast('Create failed: ' + err.message);
      }
    }
    
    function esc(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }
    
    window.addEventListener('DOMContentLoaded', () => {
      loadKeys();
    });
    
    document.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault();
        if (currentKey) saveKey();
      }
      if (e.key === 'Escape') hideCreateModal();
    });
  </script>
</body>
</html>

