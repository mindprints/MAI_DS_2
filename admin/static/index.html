<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
  <title>MAI Admin</title>
  <style>
    :root { --bg:#0b1220; --panel:#0f172a; --panel2:#111827; --border:#334155; --muted:#94a3b8; --text:#e5e7eb; --accent:#06b6d4; --danger:#ef4444; }
    html, body { height:100%; }
    body { background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; margin:20px; }
    .row{ display:flex; gap:16px; align-items:flex-start; } .col{ flex:1; }
    .card{ background:var(--panel); border:1px solid var(--border); padding:12px; border-radius:10px; margin-bottom:20px; }
    table{ border-collapse:collapse; width:100%; } th{ text-align:left; background:var(--panel2); } td,th{ border:1px solid var(--border); padding:8px; vertical-align:top; }
    input[type=text],input[type=number],textarea,select,button{ background:var(--panel2); color:var(--text); border:1px solid var(--border); border-radius:8px; padding:8px 10px; }
    input[type=text],textarea{ width:100%; } textarea{ min-height:72px; line-height:1.4; }
    .toolbar{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .seg{ display:flex; gap:10px; align-items:flex-start; margin-bottom:10px; }
    .badge{ font-size:12px; padding:3px 8px; border-radius:999px; background:#1f2937; border:1px solid var(--border); color:var(--muted); white-space:nowrap; min-width:40px; text-align:center; }
    .badge.h1,.badge.h2,.badge.h3{ color:#f59e0b; border-color:#f59e0b33; background:#f59e0b14; }
    .badge.p,.badge.li,.badge.blockquote{ color:#38bdf8; border-color:#38bdf833; background:#38bdf814; }
    .muted{ color:var(--muted); font-size:90%; }
    #toast{ position:fixed; right:16px; bottom:16px; background:#0f172a; border:1px solid var(--border); padding:10px 12px; border-radius:8px; display:none; }
    .stack{ display:flex; flex-direction:column; gap:8px; }
  </style>
  <script>
    const isHosted = typeof window !== 'undefined' && location && location.hostname && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1';
    const isDokploy = typeof window !== 'undefined' && location && location.hostname === 'app.aimuseum.site';
    const useGitHubAPI = isHosted && !isDokploy;
    const isVercelHost = useGitHubAPI;
    const API_BASE = '';
    async function api(path, opts){ const res=await fetch(API_BASE+path,opts); const ok=res.ok; const ct=res.headers.get('content-type')||''; const data=ct.includes('application/json')?await res.json():await res.text(); if(!ok) throw new Error(typeof data==='string'?data:(data.error||'request failed')); return data; }
    function toast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none',4000); }

    function controlForSegment(locale, seg){ const tag=(seg.parentTag||'').toLowerCase(); const idAttr=`data-id="${seg.id}"`; const safe=seg.text.replace(/&/g,'&amp;').replace(/"/g,'&quot;'); const isHeading=['h1','h2','h3','h4','h5','h6'].includes(tag); const isParagraph=['p','li','blockquote','figcaption'].includes(tag); const badge=`<span class="badge ${tag}">${tag.toUpperCase()}</span>`; if(isHeading) return `<div class="seg">${badge}<input type="text" ${idAttr} value="${safe}"></div>`; if(isParagraph){ const rows=Math.min(10,Math.max(2,Math.ceil(seg.text.length/90))); return `<div class="seg">${badge}<textarea ${idAttr} rows="${rows}">${seg.text.replace(/</g,'&lt;')}</textarea></div>`;} return `<div class="seg">${badge}<input type="text" ${idAttr} value="${safe}"></div>`; }

    // Endpoint helpers for pages and encyclopedia
    const PagesAPI = {
      async list(){
        if (useGitHubAPI) {
          const m = await api('/api/admin-pages?list=1');
          return { slugs:m.slugs||[], home:m.home||['index'] };
        } else {
          return api('/api/pages');
        }
      },
      async get(slug, locale){
        if (useGitHubAPI) return api(`/api/admin-pages?slug=${encodeURIComponent(slug)}&locale=${locale}`);
        return api(`/api/page-segments/${encodeURIComponent(slug)}?locale=${locale}`);
      },
      async put(slug, locale, updates){
        const body = { method:'PUT', headers:{'content-type':'application/json'}, body: JSON.stringify({ updates }) };
        if (useGitHubAPI) return api(`/api/admin-pages?slug=${encodeURIComponent(slug)}&locale=${locale}`, body);
        return api(`/api/page-segments/${encodeURIComponent(slug)}?locale=${locale}`, body);
      }
    };
    const EncyAPI = {
      async list(){
        if (useGitHubAPI) { const m=await api('/api/admin-pages?list=1&type=ency'); return m.slugs||[]; }
        const m = await api('/api/ency'); return m.slugs||[];
      },
      async get(slug, locale){
        if (useGitHubAPI) return api(`/api/admin-pages?type=ency&slug=${encodeURIComponent(slug)}&locale=${locale}`);
        return api(`/api/ency-segments/${encodeURIComponent(slug)}?locale=${locale}`);
      },
      async put(slug, locale, updates){
        const body = { method:'PUT', headers:{'content-type':'application/json'}, body: JSON.stringify({ updates }) };
        if (useGitHubAPI) return api(`/api/admin-pages?type=ency&slug=${encodeURIComponent(slug)}&locale=${locale}`, body);
        return api(`/api/ency-segments/${encodeURIComponent(slug)}?locale=${locale}`, body);
      }
    };

    const Modes = { FILES: 'files', DB: 'db' };
    let currentMode = Modes.FILES;
    let currentDbKey = '';

    function setMode(mode){
      const next = mode === Modes.DB ? Modes.DB : Modes.FILES;
      currentMode = next;
      const filePanel = document.getElementById('file-mode');
      const dbPanel = document.getElementById('db-mode');
      if (filePanel) filePanel.style.display = next === Modes.FILES ? '' : 'none';
      if (dbPanel) dbPanel.style.display = next === Modes.DB ? '' : 'none';
      const select = document.getElementById('mode');
      if (select && select.value !== next) select.value = next;
      if (next === Modes.DB && dbPanel && !dbPanel.dataset.loaded){
        loadDbKeys().catch(err => toast('Failed to load DB keys: '+err.message));
      }
    }

    function clearDbEditor(){
      currentDbKey = '';
      const en = document.getElementById('db-en');
      const sv = document.getElementById('db-sv');
      const updated = document.getElementById('db-updated');
      if (en) en.value = '';
      if (sv) sv.value = '';
      if (updated) updated.textContent = '—';
    }

    async function loadDbKeys(){
      const panel = document.getElementById('db-mode');
      if (!panel) return;
      const prefixInput = document.getElementById('db-prefix');
      const select = document.getElementById('db-key');
      if (!select) return;
      const prefix = prefixInput ? prefixInput.value.trim() : '';
      let url = '/api/db/text-snippets';
      if (prefix) url += `?prefix=${encodeURIComponent(prefix)}`;
      try {
        const data = await api(url);
        const items = Array.isArray(data.items) ? data.items : [];
        select.innerHTML = '';
        items.forEach(item => {
          const opt = document.createElement('option');
          opt.value = item.key;
          opt.textContent = item.key;
          select.appendChild(opt);
        });
        panel.dataset.loaded = '1';
        if (items.length){
          select.value = items[0].key;
          await loadDbEntry();
          toast(`Loaded ${items.length} text keys.`);
        } else {
          clearDbEditor();
          toast('No matching keys.');
        }
      } catch (e) {
        clearDbEditor();
        const msg = e && e.message ? e.message : String(e);
        toast('Failed to load DB keys: '+msg);
        const selectEl = document.getElementById('mode');
        if (msg.toLowerCase().includes('database not configured') && selectEl){
          const option = selectEl.querySelector('option[value="db"]');
          if (option) option.disabled = true;
          setMode(Modes.FILES);
        }
      }
    }

    async function loadDbEntry(){
      const select = document.getElementById('db-key');
      if (!select || !select.value){
        clearDbEditor();
        return;
      }
      const key = select.value;
      try {
        const data = await api(`/api/db/text-snippets/${encodeURIComponent(key)}`);
        currentDbKey = key;
        const en = document.getElementById('db-en');
        const sv = document.getElementById('db-sv');
        const updated = document.getElementById('db-updated');
        if (en) en.value = (data.values && typeof data.values.en === 'string') ? data.values.en : '';
        if (sv) sv.value = (data.values && typeof data.values.sv === 'string') ? data.values.sv : '';
        if (updated) updated.textContent = data.updated_at ? new Date(data.updated_at).toLocaleString() : '—';
      } catch (e) {
        clearDbEditor();
        toast('Failed to load entry: '+e.message);
      }
    }

    async function saveDbEntry(){
      if (!currentDbKey){
        toast('Select a key first.');
        return;
      }
      const en = document.getElementById('db-en');
      const sv = document.getElementById('db-sv');
      const values = {};
      if (en && typeof en.value === 'string') values.en = en.value;
      if (sv && typeof sv.value === 'string') values.sv = sv.value;
      try {
        await api(`/api/db/text-snippets/${encodeURIComponent(currentDbKey)}`, {
          method: 'PUT',
          headers: { 'content-type': 'application/json' },
          body: JSON.stringify({ values })
        });
        toast('Saved to database.');
        await loadDbEntry();
      } catch (e) {
        toast('Save failed: '+e.message);
      }
    }

    // Pages (text-only)
    let currentSlug='index';
    async function loadSlugs(){ try{ const m=await PagesAPI.list(); const sel=document.getElementById('slug'); sel.innerHTML=''; const all=['index',...(m.slugs||[])]; for(const s of all){const o=document.createElement('option');o.value=s;o.textContent=s;sel.appendChild(o);} sel.value=currentSlug; await loadSegments(); } catch(e){ toast('Failed to load slugs: '+e.message); } }
    async function loadSegments(){ const slug=document.getElementById('slug').value; try{ const en=await PagesAPI.get(slug,'en'); const sv=await PagesAPI.get(slug,'sv'); renderSegments('en',en.segments); renderSegments('sv',sv.segments); } catch(e){ toast('Failed to load segments: '+e.message); } }
    function renderSegments(locale, segs){ const box=document.getElementById('seg_'+locale); box.innerHTML=''; box.className='stack'; (segs||[]).forEach(s=>{ box.insertAdjacentHTML('beforeend', controlForSegment(locale,s)); }); }
    async function saveSegments(){ const slug=document.getElementById('slug').value; try{ for(const locale of ['en','sv']){ const fields=[...document.querySelectorAll(`#seg_${locale} [data-id]`)]; const updates=fields.map(i=>({id:i.dataset.id,text:i.value})); await PagesAPI.put(slug, locale, updates); } toast('Saved and commit created' + (isVercelHost ? '. Vercel will rebuild automatically.' : '.')); } catch(e){ toast('Save failed: '+e.message); } }

    // Slides
    let slidesFiles=[],slidesManifest=[];
    const SlidesAPI = {
      async list(){ return isHosted ? api('/api/admin-slides') : api('/api/slides'); },
      async saveManifest(manifest){ return isHosted ? api('/api/admin-slides',{method:'PUT',headers:{'content-type':'application/json'},body:JSON.stringify(manifest)}) : api('/api/slides',{method:'PUT',headers:{'content-type':'application/json'},body:JSON.stringify(manifest)}); },
      async upload(file){
        if (isHosted) {
          const buf=await file.arrayBuffer(); const b64=btoa(String.fromCharCode(...new Uint8Array(buf)));
          return api('/api/admin-slides',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({name:file.name,contentBase64:b64})});
        } else {
          const buf=await file.arrayBuffer();
          return fetch('/api/slides/upload?name='+encodeURIComponent(file.name), { method:'POST', headers:{}, body: buf }).then(r=>{ if(!r.ok) return r.text().then(t=>{ throw new Error(t||'upload failed'); }); return r.json(); });
        }
      },
      async delete(name){ return isHosted ? api('/api/admin-slides?name='+encodeURIComponent(name),{method:'DELETE'}) : api('/api/slides?name='+encodeURIComponent(name),{method:'DELETE'}); }
    };
    function getOrMakeEntry(filename){ let it=slidesManifest.find(x=>x.filename===filename); if(!it){ it={number:9999,filename,title:filename,description:'',i18n:{en:{title:'',description:''},sv:{title:'',description:''}}}; slidesManifest.push(it);} if(!it.i18n) it.i18n={en:{title:'',description:''},sv:{title:'',description:''}}; if(!it.i18n.en) it.i18n.en={title:'',description:''}; if(!it.i18n.sv) it.i18n.sv={title:'',description:''}; return it; }
    function renderSlides(){ const tbody=document.querySelector('#slides tbody'); tbody.innerHTML=''; const rows=slidesFiles.map(fn=>getOrMakeEntry(fn)); rows.sort((a,b)=>(a.number||9999)-(b.number||9999)||a.filename.localeCompare(b.filename)); for(const it of rows){ const tr=document.createElement('tr'); tr.innerHTML=`<td><img src="/src/site/images/slide/${it.filename}" alt="" width="80"></td><td><input type="number" value="${it.number||''}"></td><td class="muted">${it.filename}</td><td><input type="text" value="${(it.i18n.en.title||'').replace(/&/g,'&amp;')}"></td><td><input type="text" value="${(it.i18n.en.description||'').replace(/&/g,'&amp;')}"></td><td><input type="text" value="${(it.i18n.sv.title||'').replace(/&/g,'&amp;')}"></td><td><input type="text" value="${(it.i18n.sv.description||'').replace(/&/g,'&amp;')}"></td><td><button class="danger" data-del="${it.filename}">Delete</button></td>`; const [imgTd,numTd,fileTd,enTitleTd,enDescTd,svTitleTd,svDescTd,delTd]=tr.children; numTd.querySelector('input').addEventListener('input',e=>{it.number=parseInt(e.target.value||'0',10)||undefined;}); enTitleTd.querySelector('input').addEventListener('input',e=>{it.i18n.en.title=e.target.value;}); enDescTd.querySelector('input').addEventListener('input',e=>{it.i18n.en.description=e.target.value;}); svTitleTd.querySelector('input').addEventListener('input',e=>{it.i18n.sv.title=e.target.value;}); svDescTd.querySelector('input').addEventListener('input',e=>{it.i18n.sv.description=e.target.value;}); delTd.querySelector('button').addEventListener('click',()=>deleteSlide(it.filename)); tbody.appendChild(tr);} }
    async function loadSlides(){ try{ const d=await SlidesAPI.list(); slidesFiles=d.files||[]; slidesManifest=Array.isArray(d.manifest)?d.manifest:[]; renderSlides(); } catch(e){ toast('Failed to load slides: '+e.message); } }
    async function saveSlides(){ try{ await SlidesAPI.saveManifest(slidesManifest); toast('Slides manifest saved. Rebuild triggered.'); } catch(e){ toast('Save manifest failed: '+e.message); } }
    async function uploadSlide(){ const f=document.getElementById('upload').files[0]; if(!f) return alert('Choose a file'); try{ await SlidesAPI.upload(f); await loadSlides(); toast('Uploaded. Rebuild triggered.'); } catch(e){ toast('Upload failed: '+e.message); } }
    async function deleteSlide(name){ if(!confirm(`Delete ${name}?`))return; try{ await SlidesAPI.delete(name); await loadSlides(); toast('Deleted. Rebuild triggered.'); } catch(e){ toast('Delete failed: '+e.message); } }

    // Encyclopedia management
    async function loadEncyList(){ try{ const list=await EncyAPI.list(); const sel=document.getElementById('ency-slug'); sel.innerHTML=''; list.forEach(s=>{ const o=document.createElement('option'); o.value=s; o.textContent=s; sel.appendChild(o); }); if(list.length){ sel.value=list[0]; await loadEncyEntry(); } } catch(e){ toast('Failed to load encyclopedia list: '+e.message); } }
    async function loadEncyEntry(){ const slug=document.getElementById('ency-slug').value; try{ const en=await EncyAPI.get(slug,'en'); const sv=await EncyAPI.get(slug,'sv'); renderEncySegments('en',en.segments); renderEncySegments('sv',sv.segments); } catch(e){ toast('Failed to load entry: '+e.message); } }
    function renderEncySegments(locale, segs){ const box=document.getElementById('ency_'+locale); box.innerHTML=''; box.className='stack'; (segs||[]).forEach(s=>{ box.insertAdjacentHTML('beforeend', controlForSegment(locale,s)); }); }
    async function saveEncyEntry(){ const slug=document.getElementById('ency-slug').value; try{ for(const locale of ['en','sv']){ const fields=[...document.querySelectorAll(`#ency_${locale} [data-id]`)]; const updates=fields.map(i=>({id:i.dataset.id,text:i.value})); await EncyAPI.put(slug, locale, updates); } toast('Encyclopedia entry saved. Rebuild triggered.'); } catch(e){ toast('Save failed: '+e.message); } }

    window.addEventListener('DOMContentLoaded', async () => {
      const modeSelect = document.getElementById('mode');
      if (modeSelect) {
        if (useGitHubAPI) {
          const opt = modeSelect.querySelector('option[value="db"]');
          if (opt) opt.disabled = true;
        }
        setMode(modeSelect.value);
      }
      await loadSlugs();
      await loadEncyList();
    });
  </script>
</head>
<body>
  <h1>MAI Admin</h1>
  <div id="toast"></div>

  <section class="card">
    <div class="toolbar">
      <label for="mode">Content Mode:</label>
      <select id="mode" onchange="setMode(this.value)">
        <option value="files">Files (HTML)</option>
        <option value="db">Database (Postgres)</option>
      </select>
    </div>
  </section>

  <div id="file-mode">
    <section class="card">
      <h2>Pages (Text-only)</h2>
      <div class="toolbar">
        <label for="slug">Page:</label>
        <select id="slug" onchange="loadSegments()"></select>
        <button onclick="saveSegments()">Save Text</button>
        <button onclick="(async()=>{try{await fetch(API_BASE+'/admin-pages?noop=1');alert('On Vercel, builds are triggered by commit; this admin commits directly to GitHub.');}catch(_){}})()">Build</button>
      </div>
      <div class="row" style="margin-top:10px;">
        <div class="col"><h3>English</h3><div id="seg_en"></div></div>
        <div class="col"><h3>Svenska</h3><div id="seg_sv"></div></div>
      </div>
      <p class="muted">Only text content is editable; HTML structure and classes are preserved.</p>
    </section>

    <section class="card">
      <h2>Slides</h2>
      <div class="toolbar">
        <button onclick="loadSlides()">Load</button>
        <input type="file" id="upload" accept=".webp,.jpg,.jpeg,.png,.avif">
        <button onclick="uploadSlide()">Upload</button>
        <button onclick="saveSlides()">Save Manifest</button>
      </div>
      <table id="slides">
        <thead><tr><th>Preview</th><th>#</th><th>Filename</th><th>EN Title</th><th>EN Desc</th><th>SV Title</th><th>SV Desc</th><th></th></tr></thead>
        <tbody></tbody>
      </table>
      <p class="muted">On Vercel, uploads/edits commit to GitHub and trigger a rebuild automatically.</p>
    </section>

    <section class="card">
      <h2>Encyclopedia</h2>
      <div class="toolbar">
        <label for="ency-slug">Entry:</label>
        <select id="ency-slug" onchange="loadEncyEntry()"></select>
        <button onclick="saveEncyEntry()">Save Entry</button>
      </div>
      <div class="row" style="margin-top:10px;">
        <div class="col"><h3>English</h3><div id="ency_en"></div></div>
        <div class="col"><h3>Svenska</h3><div id="ency_sv"></div></div>
      </div>
      <p class="muted">Text-only edits; entries live in <code>src/content/encyclopedia/</code> as <code>slug.en.html</code> and <code>slug.sv.html</code>.</p>
    </section>
  </div>

  <section id="db-mode" class="card" style="display:none">
    <h2>Database Text Snippets</h2>
    <div class="toolbar">
      <label for="db-prefix">Filter:</label>
      <input type="text" id="db-prefix" placeholder="e.g. page.home">
      <button onclick="loadDbKeys()">Load Keys</button>
      <label for="db-key">Key:</label>
      <select id="db-key" onchange="loadDbEntry()"></select>
      <button onclick="saveDbEntry()">Save Text</button>
    </div>
    <p class="muted">Updates write directly to <code>text_snippets</code> in Postgres.</p>
    <div class="row" style="margin-top:10px;">
      <div class="col"><h3>English</h3><textarea id="db-en" rows="12"></textarea></div>
      <div class="col"><h3>Svenska</h3><textarea id="db-sv" rows="12"></textarea></div>
    </div>
    <p class="muted">Last updated: <span id="db-updated">—</span></p>
  </section>
</body>
</html>
