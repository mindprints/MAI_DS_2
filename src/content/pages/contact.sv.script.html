<script>
// Klientlogik; e-post skickas via /api/send-email
    // Normalisera sträng (ta bort accenter, gemener)
    function norm(s) {
      return (s || '')
        .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
        .toLowerCase().trim();
    }

    // Alias-karta: mappar olika svenska/engelska värden till exakt svenska option-värden
    const TOPIC_ALIASES = {
      // Svenska -> Svenska
      [norm('Allmän kontakt')]: 'Allmän kontakt',
      [norm('Medlemsansökan')]: 'Medlemsansökan',
      [norm('Workshop/Föreläsning')]: 'Workshop/Föreläsning',
      [norm('Press Center')]: 'Press Center',
      [norm('Karriär')]: 'Karriär',
      [norm('Partnerskap')]: 'Partnerskap',
      [norm('Donation/Sponsring')]: 'Donation/Sponsring',
      [norm('Lokaluthyrning')]: 'Lokaluthyrning',
      [norm('Tillgänglighet')]: 'Tillgänglighet',
      [norm('Annat')]: 'Annat',

      // Engelska -> Svenska
      [norm('General Contact')]: 'Allmän kontakt',
      [norm('Membership Application')]: 'Medlemsansökan',
      [norm('Workshop/Lecture Enquiry')]: 'Workshop/Föreläsning',
      [norm('Press Center')]: 'Press Center',
      [norm('Careers')]: 'Karriär',
      [norm('Partnerships')]: 'Partnerskap',
      [norm('Donations/Sponsorship')]: 'Donation/Sponsring',
      [norm('Venue Hire')]: 'Lokaluthyrning',
      [norm('Accessibility')]: 'Tillgänglighet',
      [norm('Other')]: 'Annat'
    };

    // Förvälj ämne från ?topic= med stöd för svenska/engelska och accenter
    (function prefillTopic() {
      const params = new URLSearchParams(location.search);
      const raw = params.get('topic');
      if (!raw) return;

      const mapped = TOPIC_ALIASES[norm(raw)];
      const select = document.getElementById('topic');

      if (mapped) {
        select.value = mapped;
      } else {
        // Fallback: välj "Annat"
        select.value = 'Annat';
      }
    })();

    // Bygg ett rikt meddelande som inkluderar ev. extra fält
    function composeMessage() {
      const get = id => document.getElementById(id)?.value.trim();
      const topic = get('topic');
      const name = get('name');
      const email = get('email');
      const org = get('organization');
      const phone = get('phone');
      const website = get('website');
      const geo = get('geo');
      const budget = get('budget');
      const timeline = get('timeline');
      const message = get('message');

      const lines = [
        `Ämne: ${topic || '—'}`,
        `Namn: ${name || '—'}`,
        `E-post: ${email || '—'}`,
        org ? `Organisation: ${org}` : null,
        phone ? `Telefon: ${phone}` : null,
        website ? `Webbplats: ${website}` : null,
        geo ? `Plats: ${geo}` : null,
        budget ? `Budget: ${budget}` : null,
        timeline ? `Tidplan: ${timeline}` : null,
        '',
        'Meddelande:',
        message || '—'
      ].filter(Boolean);

      return lines.join('\n');
    }

    document.getElementById('contact-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      const feedback = document.getElementById('contact-feedback');

      const name = form.name.value.trim();
      const email = form.email.value.trim();
      const msg = form.message.value.trim();

      if (!name || !email || !msg) {
        alert('Fyll i namn, e-post och ett meddelande.');
        return;
      }

      const fullMessage = composeMessage();

      const payload = {
        kind: 'contact',
        name,
        email,
        message: fullMessage,
        reply_to: email,
        from_name: 'MAI Website',
        from_email: 'info@aimuseum.se'
      };

      const btn = form.querySelector('button[type="submit"]');
      btn.disabled = true; btn.textContent = 'Skickar…'; feedback.textContent = '';

      try {
        const resp = await fetch('/api/send-email', {
          method: 'POST',
          headers: { 'content-type': 'application/json' },
          body: JSON.stringify(payload),
        });
        if (!resp.ok) {
          const data = await resp.json().catch(() => ({}));
          throw new Error(data?.error || 'Failed to send');
        }
        feedback.textContent = 'Tack! Ditt meddelande har skickats.';
        form.reset();
      } catch (err) {
        console.error('Send error:', err);
        feedback.textContent = 'Tyvärr uppstod ett fel vid sändning.';
      } finally {
        btn.disabled = false; btn.textContent = 'Skicka meddelande';
      }
    });
</script>
